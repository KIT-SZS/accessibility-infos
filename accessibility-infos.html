<link rel="import" href="components/polymer/polymer.html">
<link rel="import" href="components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="components/paper-dropdown/paper-dropdown.html">
<link rel="import" href="components/paper-item/paper-item.html">
<link rel="import" href="components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="components/core-ajax/core-ajax.html">
<link rel="import" href="components/core-selector/core-selector.html">
<link rel="import" href="components/core-header-panel/core-header-panel.html">
<link rel="import" href="components/core-toolbar/core-toolbar.html">
<link rel="import" href="components/core-collapse/core-collapse.html">
<link rel="import" href="components/core-tooltip/core-tooltip.html">
<link rel="import" href="components/core-pages/core-pages.html">

<link rel="import" href="accessibility-map.html">

<script src="Set.js"></script>
<script src="components/i18next/i18next.js"></script>


<polymer-element name="accessibility-infos">
<template>
  <link href="./accessibility-infos.css" rel="stylesheet" ></link>
  <core-header-panel flex mode="seamed">
      <core-toolbar>
        <core-selector selected="1" id="menuItems">
          <core-tooltip label="Filter by disability">
            <paper-icon-button icon="menu"></paper-icon-button>
          </core-tooltip>
          <core-tooltip label="Filter by disability">
            <paper-icon-button icon="menu"></paper-icon-button>
          </core-tooltip>
        </core-selector>

        <span flex>
          <section >
            <h4>Gebäude</h4>
            <paper-dropdown selected="{{selectedBuildingIndex}}" id="buildingSelector">
                <template repeat="{{building in buildings}}">
                  <paper-item label="{{building.name}} {{building.nb}}"></paper-item>
                </template>
            </paper-dropdown>
          </section>

          <template if="{{selectedBuilding}}">
            <section>
              <h4>Räume</h4>
                <paper-dropdown selected="{{selectedRoomIndex}}" id="roomSelector">
                    <template repeat="{{room in rooms[selectedBuilding.nb]}}">
                      <paper-item label="{{room.name}} {{room.nb}}"></paper-item>
                    </template>
                </paper-dropdown>
            </section>
          </template>
        </span>
         <span flex>
           <section>
            Notruf: 
          </section>
        </span>
      </core-toolbar>
      <div class="content" fit>
        
        <core-pages class="controls" selected="{{$.menuItems.selected}}" >
          <div id="fake"></div>
          <article id="controls"> 
            <section>
              <h4>Sehen</h4>
              <paper-radio-group selected="{{selectedVisualDisability}}">
                <template repeat="{{disability in visualDisabilities}}">
                  <paper-radio-button name="{{disability}}" label="{{disability}}"></paper-radio-button>
                </template>
              </paper-radio-group>
            </section>

            <section>
              <h4>Hören</h4>
              <paper-radio-group selected="{{selectedHearingDisability}}">
                <template repeat="{{disability in hearingDisabilities}}">
                  <paper-radio-button name="{{disability}}" label="{{disability}}"></paper-radio-button>
                </template>
              </paper-radio-group>
            </section>

            <section>
              <h4>Gehen</h4>
              <paper-radio-group selected="{{selectedMovementDisability}}">
                <template repeat="{{disability in movementDisabilities}}">
                  <paper-radio-button name="{{disability}}" label="{{disability}}"></paper-radio-button>
                </template>
              </paper-radio-group>
            </section>

          </article>
        </core-pages>

        <article id="data">
            <section id="textData">
              <template if="{{selectedBuilding && !filteredSelectedRoom}}">
                <section id="buildingInfos">
                  <h1>Gebaude Informationen</h1>   
                    <core-selector selected="{{selectedBuildingInfo}}">
                       <template repeat="{{item,i in selectedBuilding | getKeys}}" >
                         <template if="{{selectedBuilding[item] | isNotObject}}">
                            <div>
                              <div class="itemName">{{item | translator(item)}} </div>
                              <div class="itemText">{{selectedBuilding[item] | toGermanBoolean }}</div>
                            </div>
                         </template>
                         <template if="{{selectedBuilding[item] | isObject}}">
                              <core-collapse opened?="{{selectedBuildingInfo == i}}" fixedSize>
                                <h5 style="width:100%"> {{item | translator(item) }} </h5>
                                  <section>
                                    <template repeat="{{subitem in selectedBuilding[item] | getKeys}}" >
                                      <div>
                                        <div class="itemName"> {{subitem| translator(subitem)}} </div>
                                        <div class="itemText"> {{selectedBuilding[item][subitem] | cleanSub | toGermanBoolean }} </div>
                                      </div>
                                    </template>
                                </section>
                              </core-collapse>
                         </template>
                      </template>
                    </core-selector>
                </section>
              </template>

              <template if="{{filteredSelectedRoom}}">
                  <section id="roomInfos">
                    <h1>Raum Informationen</h1>   

                       <core-selector selected="{{selectedRoomInfo}}">
                         <template repeat="{{item, i in filteredSelectedRoom | getKeys}}" >
                           <template if="{{filteredSelectedRoom[item] | isNotObject}}">
                              <div>
                                <div class="itemName">{{item | translator(item) }}</div>
                                <div class="itemText">{{filteredSelectedRoom[item] | toGermanBoolean }}</div>
                              </div>
                           </template>
                           <template if="{{filteredSelectedRoom[item] | isObject}}">
                                <core-collapse opened?="{{selectedRoomInfo == i}}" fixedSize>
                                  <h5 style="width:100%"> {{item | translator(item) }} </h5>
                                    <section>
                                      <template repeat="{{subitem in filteredSelectedRoom[item] | getKeys}}" >
                                        <div>
                                          <div class="itemName"> {{subitem | translator(subitem)}} </div>
                                          <div class="itemText"> {{filteredSelectedRoom[item][subitem] | toGermanBoolean  }} </div>
                                        </div>
                                      </template>
                                  </section>
                                </core-collapse>
                           </template>
                        </template>
                      </core-selector>
                  </section>
              </template>
            </section>
            <section id="mapData">
              <template if="{{displayMode=='map'}}">
                <accessibility-map> </accessibility-map>
              </template>
            </section>
        </article>  
      </div>
   </core-header-panel>
  <!--data loaders-->
  <core-ajax auto url="buildings.json" handleAs="json" on-core-error="{{buildingsRawResponse}}" response="{{buildingsRaw}}" sync=true></core-ajax>
  <core-ajax auto url="roomsByBuilding.json"   handleAs="json" response="{{roomsRaw}}"   sync=true></core-ajax>
  <core-ajax auto url="filters.json" handleAs="json" response="{{filtersRaw}}" sync=true></core-ajax>

</template>
<script>
  Polymer("accessibility-infos", {
    buildingsRaw:null,
    roomsRaw:null,
    filtersRaw:null,


    visualDisabilities:null,
    hearingDisabilities:null,
    movementDisabilities:null,
    rooms:null,
    buildings:null,


    selectedVisualDisability:'NA',
    selectedHearingDisability:'NA',
    selectedMovementDisability:'NA',
    selectedBuildingIndex:-1,
    selectedBuilding     :null,
    selectedRoomIndex    :-1,
    selectedRoom         :null,

    selectedRoomInfo     :1, 
    selectedBuildingInfo :1,

    displayMode:'NA',//can be NA, map, text

    filteredSelectedBuilding:null,
    filteredSelectedRoom:null,

    created:function(){
      this.visualDisabilities= ["sehbehindert","blind","NA"];
      this.hearingDisabilities = ["schwerhörig","gehörlos","NA"];
      this.movementDisabilities=["gehbehindert","rollstullfahrer","NA"];

      var options = { resGetPath: 'locales/__lng__/__ns__-__lng__.json',load:['de-DE'], preload: ['de-DE'],lngWhitelist: ['de-DE'],fallbackLng:'de-DE',fallbackToDefaultNS: true  };
      i18n.init(options, function(t) {console.log("internationalization loaded");});

      this.disabilityFieldMap = null;
      this.buildings          = null;
      this.rooms              = null;
    },
    attached:function(){
      this.updateBasedOnDisability();
    },
    domReady:function(){
    },

    //attribute change handlers
    selectedVisualDisabilityChanged:function(){
      this.updateBasedOnDisability();
    },
    selectedHearingDisabilityChanged:function(){
      this.updateBasedOnDisability();
    },
    selectedMovementDisabilityChanged:function(){
      this.updateBasedOnDisability();
    },
    selectedBuildingIndexChanged:function(){
      this.selectedBuilding = this.buildings[this.selectedBuildingIndex-1];

      this.selectedRoomIndex = -1;
      this.selectedRoom = null;
      this.filteredSelectedRoom = null;
    },
    selectedBuildingChanged:function(){
      console.log("selected building changed", this.selectedBuilding);
      this.filterBuilding();
    },
    selectedRoomIndexChanged:function(){
      console.log("selectedRoomIndexChanged",this.selectedRoomIndex);
      var selectedBldNB = this.buildings[this.selectedBuildingIndex-1].nb;
      this.selectedRoom = this.rooms[selectedBldNB][this.selectedRoomIndex-1];
    },
    selectedRoomChanged:function(){
      console.log("selected room changed", this.selectedRoom);
      this.filterRoom();
    },

    buildingsRawChanged:function(){
      console.log("buildingsRawChanged");
      this.buildings = this.buildingsRaw;
    },
    roomsRawChanged:function(){
      console.log("roomsRawChanged");
      this.rooms = this.roomsRaw;
    },
    filtersRawChanged:function(){
      console.log("filtersRawChanged");
      this.disabilityFieldMap = this.filtersRaw;
    },
    //helpers
    updateBasedOnDisability:function(){
      if(this.selectedVisualDisability == "sehbehindert" || this.selectedVisualDisability == "NA")
      {
        this.displayMode = 'map';
      }else if(this.selectedVisualDisability =="blind"){
        this.displayMode = 'text';
      }
      this.filterRoom();
    },
    filterRoom:function(){
      console.log("this.selectedRoom", this.selectedRoom);
      if(this.selectedRoom) this.filteredSelectedRoom = this.filterByDisability( this.selectedRoom, "rooms" );
    },
    filterBuilding:function(){
      console.log("this.selectedBuilding", this.selectedBuilding);
      if(this.selectedBuilding) this.filteredSelectedBuilding = this.filterByDisability( this.filteredSelectedBuilding, "buildings" );
    },
    filterByDisability:function( data, type ){
      if(!this.disabilityFieldMap) return data;
      var type = type || "rooms";
      console.log("filtering");

      var fieldMapVisual = this.disabilityFieldMap[type];
      var fieldMapHearing = this.disabilityFieldMap[type];
      var fieldMapMovement = this.disabilityFieldMap[type];

      if(fieldMapVisual){ fieldMapVisual = fieldMapVisual[this.selectedVisualDisability]; }
      else{ fieldMapVisual = null; }

      if(fieldMapHearing){ fieldMapHearing = fieldMapHearing[this.selectedHearingDisability]; }
      else{ fieldMapHearing = null; }

      if(fieldMapMovement){ fieldMapMovement = fieldMapMovement[this.selectedMovementDisability]; }
      else{ fieldMapMovement = null; }
 

      if(fieldMapVisual === undefined && fieldMapHearing === undefined && fieldMapMovement === undefined) return data;

      var fieldMaps = [ fieldMapVisual, fieldMapHearing, fieldMapMovement ];
      var result = {};
  

      function deepValue(obj, path){
          for (var i=0, path=path.split('.'), len=path.length; i<len; i++){
              obj = obj[path[i]];
          };
          return obj;
      };


      function validField(fieldName)
      {
        var displayField = false;
        for(var i=0;i<fieldMaps.length;i++)
        {
          var fieldMap = fieldMaps[i];
          if(!fieldMap) continue;
          var bang = deepValue(fieldMap, fieldName);
          displayField = displayField | bang;
        }
        //console.log("display field",fieldName ,Boolean(displayField));
        return displayField;
      }

      function iterate(obj, propPath, result) {
        for (var property in obj) {
          if (obj.hasOwnProperty(property)) {
            if (typeof obj[property] == "object" && obj[property] !==null && obj[property] !== undefined) {
                result[property] = {};
                iterate(obj[property], propPath + '.' + property, result[property]);
                if(Object.keys(result[property]).length ==0)
                {
                  delete result[property];
                }
            } 
            else
            {
              var propPathSub = "";
              if(propPath!=="") { propPathSub = propPath+"."+property}
              else{ propPathSub = property;} 
              if(propPathSub[0] == ".") propPathSub = propPathSub.substring(1);
              
              console.log("propPath",propPathSub);
              if(validField(propPathSub))
              {
                result[property] = obj[property];
              }
            }
          }
        }
      }

      var propPath = "";
      iterate(this.selectedRoom, propPath, result);
      
      return result;
    },
    toGermanBoolean:function(source){
      if(source == undefined || source == null) return "";
      if(!this.isBoolean(source)) return source;
      if(source) return "ja";
      return "nein";
    },
    toBold:function(source){
      return source.toUpperCase();
    },
    getKeys : function(o){
      return Object.keys(o);
    },
    isObject : function(v){
      return (typeof(v) === "object" && !(Array.isArray(v)) && (v !== null ) && (v !== undefined) );
    },
    isNotObject : function(v){
      return typeof(v) !== "object";
    },
    isBoolean: function(o){
      return typeof(o) === "boolean";
    },
    //FIXME: for whatever reason renaming this method to "translate"does not work ?
    translator: function(o, key){
      var i18nKey = 'app.generic.'+key;
      var translation = i18n.t('app.generic.'+key);
      if(translation == i18nKey) translation = o;
      //console.log("translating",o,key,"to",translation);
      return translation;
    },
    cleanSub:function(o)
    {
      if(!this.isObject(o)) return o;
      var res="";
      for(var key in o)
      {
        var val = o[key];
        var rKey = this.translator(key,key);
        val = this.toGermanBoolean(val);
        res+=rKey+" : "+val+"\n";
      }
      return res;//JSON.stringify(o);
    }

  });
</script>

</polymer-element>
